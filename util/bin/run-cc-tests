#!/bin/bash

set -xeuo pipefail

export DB=postgres
export DB_CONNECTION_STRING="postgres://postgres:postgres@localhost:5432/cc_test"

main() {
  set-up-postgres
  set-up-bundler

  sudo service postgresql start
  run-tests "$@"
  trap finish EXIT
}

finish() {
  sudo service postgres stop
}

set-up-postgres() {
  if ! dpkg-query -s postgresql &>/dev/null; then
    sudo apt-get update

    sudo apt install -y postgresql postgresql-contrib

    sudo service postgresql start

    echo "ALTER USER postgres PASSWORD 'postgres';" | sudo -u postgres psql
  fi
}

set-up-bundler() {
  pushd $HOME/workspace/capi-release/src/cloud_controller_ng
  {
    if ! type bundler >/dev/null; then
      bundler_version="$(cat Gemfile.lock | grep -A1 "BUNDLED WITH" | tail -1 | tr -d ' ')"
      gem install --user-install bundler --version "$bundler_version"

      bundle install
    fi
  }
  popd
}

run-tests() {
  local specs
  specs="$@"

  pushd $HOME/workspace/capi-release/src/cloud_controller_ng
  rake db:drop
  rake db:create

  if [ $# -eq 0 ]; then
    bundle exec rake spec
  else
    bundle exec rspec $specs
  fi
  popd
}

main "$@"
