#!/bin/bash

set -xeuo pipefail

export DB=postgres
export PGPASSWORD="$(pass eirini/ccng/test-db-password)"

main() {
  install-deps
  setup-postgres
  bundle-install

  run-tests "$@"
}

install-deps() {
  local deps
  deps=(postgresql postgresql-contrib libpq-dev libmysqlclient-dev)

  if ! dpkg-query -s $deps &>/dev/null; then
    sudo apt-get update
    sudo apt-get install -y $deps
  fi
}

setup-postgres() {
  if ! sudo service postgresql status >dev/null; then
    sudo service postgresql start
  fi
  echo "ALTER USER postgres PASSWORD '$PGPASSWORD';" | sudo -u postgres psql
}

bundle-install() {
  pushd $HOME/workspace/capi-release/src/cloud_controller_ng
  {
    if ! type bundler >/dev/null; then
      bundler_version="$(cat Gemfile.lock | grep -A1 "BUNDLED WITH" | tail -1 | tr -d ' ')"
      gem install --user-install bundler --version "$bundler_version"
    fi

    bundle install
  }
  popd
}

run-tests() {
  local specs
  specs="$@"

  pushd $HOME/workspace/capi-release/src/cloud_controller_ng
  if [ $# -eq 0 ]; then
    bundle exec rake spec
  else
    time bundle exec rspec $specs
  fi
  popd
}

main "$@"
